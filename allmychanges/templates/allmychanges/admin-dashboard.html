{% extends "allmychanges/new-base.html" %}
{% load staticfiles %}


{% block html-title %}{{ title }} â€“ {{ block.super }}{% endblock %}

{% block content %}
  <link href="{% static 'metricsgraphics/metricsgraphics.css' %}" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.0/d3.min.js" charset="utf-8"></script>
  <script src="{% static 'metricsgraphics/metricsgraphics.js' %}" type="text/javascript" charset="utf-8"></script>
  <script src="{% static 'highcharts/highcharts.js' %}" type="text/javascript" charset="utf-8"></script>

  <h1 class="page-header">{{ title }}</h1>

  <h2 class="page-subheader">Users, joined in last two weeks</h2>

  {% if users %}
  <table class="table">
    <tr>
      <th>Date Joined</th>
      <th>Username</th>
      <th>Email</th>
      <th>Track Changelogs</th>
      <th>Auth</th>
    </tr>
    {% for user in users %}
    <tr>
      <td>{{user.date_joined|timesince}}</td>
      <td><a href="{% url 'user-history' username=user.username %}">{{user.username}}</a></td>
      <td>{{user.email}}</td>
      <td>{{user.num_changelogs}}</td>
      <td>{{user.auth_providers|join:", "}}</td>
    </tr>
    {% endfor %}
  </table>
  {% else %}
    <p>Nobody joined in last two weeks :(<br/>
    We need to work on Marketing!</p>
  {% endif %}

  <h2 class="page-subheader">Retention</h2>

  <div id="retention-graph" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
  <script>
    var series = {{ data|safe }};
    var data_legend = R.map(R.prop('name'), series);

    $(function () {
    $('#retention-graph').highcharts({
        chart: {
            type: 'area'
        },
        title: {
            text: 'Quater Cohorts Retention'
        },
        xAxis: {
            categories: data_legend,
            tickmarkPlacement: 'on',
            title: {
                text: 'Weeks in past'
            }
        },
        yAxis: {
            title: {
                text: 'Active users'
            },
            labels: {
                formatter: function () {
                    return this.value;
                }
            }
        },
        tooltip: {
            shared: true,
            valueSuffix: ' user'
        },
        plotOptions: {
            area: {
                pointStart: - series[0].data.length,
                stacking: 'normal',
                lineColor: '#666666',
                lineWidth: 1,
                marker: {
                    enabled: false,
                    lineWidth: 1,
                    lineColor: '#666666',
                    states: {
                        hover: {
                            enabled: true
                        }
                    }
                }
            }
        },
        series: series
    });
});
</script>
{% endblock content %}
