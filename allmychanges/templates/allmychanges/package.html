{% extends "allmychanges/new-base.html" %}
{% load md2 %}
{% load allmychanges_tags %}

{% block html-title %}{{package.namespace}}/{{package.name}}'s changelog at {{block.super}}{% endblock %}
{% block top_of_head %}
{{ block.super }}
<meta content="{{package.name|title}}'s release notes.{% if package.description %} {{package.description}}{% endif %}" name="description"></meta>
<meta content="{{package.namespace}},{{package.name}},changelog,version,latest,release notes,release" name="keywords"></meta>
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@allmychanges">
<meta name="twitter:title" content="{{package.name|title}}'s release notes.">
<meta name="twitter:description" content="{% if package.description %}{{package.description}}{% else %}Latest versions{% endif %}">
<meta name="twitter:image" content="{{request|screenshot_url}}">


{% endblock %}

{% block content %}
  <h1 class="page-header">
    <div class="page-header__package-title" itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
      <a href="/catalogue/" itemprop="url">
        <span itemprop="title">All</span>
      </a>
      → 
      <div itemprop="child" itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
        <a href="/catalogue/#{{package.namespace}}" itemprop="url">
          <span itemprop="title">{{package.namespace}}</span>
        </a>
        →
        <div itemprop="child" itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
          <a href="{{package.url}}" itemprop="url">
            <span itemprop="title">{{package.name}}</span>
          </a>
          {% with package.changelog.obj.latest_version as latest_version %}
            {% if latest_version %}
              →
              <div itemprop="child" itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
                <a href="{{package.url}}#{{latest_version.number}}" itemprop="url">
                  <span itemprop="title">{{latest_version.number}}</span>
                </a>
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
  </h1>

  <div class="page-header__buttons"><a href="{% url "edit-package" namespace=namespace name=name %}" class="button" title="Tune namespace, name, source and other parameters for this changelog."><i class="fa fa-cog fa-lg" style="margin-right: 5px"></i>Tune</a> <a href="{{package.source|remove_source_prefix}}" class="button" title="Go to package's sources"><i class="fa fa-external-link-square fa-lg" style="margin-right: 5px"></i>Source</a> <div class="report-button" data-changelog-id="{{package.changelog.id}}"></div> <div class="track-button-container" data-changelog-id="{{package.changelog.id}}" data-tracked="{{already_tracked|lower}}" data-num-trackers="{{num_trackers}}"></div></div>

  <dl class="package-metadata">
    <!--dt>Badge for README:</dt>
    <dd>
      <div class="share-badge-container"
           data-namespace="{{package.namespace}}"
           data-name="{{package.name}}">Share Badge Should be Here</div>
    </dd-->
    {% if package.description %}
      <dt>Description:</dt>
      <dd>{{package.description}}</dd>
    {% endif %}
    {% if package.show_itunes_badge %}
    <dt>Install application:</dt>
    <dd>
      <a href="{{ package.source }}" target="itunes_store" style="display:inline-block;overflow:hidden;background:url(https://linkmaker.itunes.apple.com/htmlResources/assets/en_us//images/web/linkmaker/badge_appstore-lrg.png) no-repeat;width:135px;height:40px;@media only screen{background-image:url(https://linkmaker.itunes.apple.com/htmlResources/assets/en_us//images/web/linkmaker/badge_appstore-lrg.svg);}"></a>
    </dd>
    {% endif %}
    <dt>Last update was:</dt>
    <dd>{{package.changelog.updated_at|timesince}} ago</dd>
    <dt>Time to next update:</dt>
    <dd>{{package.changelog.next_update_at|timeuntil}}</dd>

    {% if package.changelog.problem %}
      <dt>Problem:</dt>
      <dd>{{package.changelog.problem}}</dd>
    {% endif %}
    {% if show_issues and issues.count %}
      <dt>Issues:</dt>
      <dd><a href="/issues/?namespace={{package.namespace}}&amp;name={{package.name}}">{{issues.count}}</a></dd>
    {% endif %}
      <dt>Versions:</dt>
      <dd>


<div class="version-links-container">
  <ul class="version-links">
    {% for version in package.versions %}
      <li class="version-links__item version-links__item-{{ version.number|replace_dots }}"><a href="#{{ version.number }}">{{ version.number }}</a></li>
    {% endfor %}
  </ul>
      <!-- START buttons -->
  <div class="version-links__buttons"><a href="{% url "edit-package" namespace=namespace name=name %}" class="button" title="Tune namespace, name, source and other parameters for this changelog."><i class="fa fa-cog fa-lg" style="margin-right: 5px"></i>Tune</a> <a href="{{package.source|remove_source_prefix}}" class="button" title="Go to package's sources"><i class="fa fa-external-link-square fa-lg" style="margin-right: 5px"></i>Source</a> <div class="report-button" data-changelog-id="{{package.changelog.id}}"></div> <div class="track-button-container" data-changelog-id="{{package.changelog.id}}" data-tracked="{{already_tracked|lower}}" data-num-trackers="{{num_trackers}}"></div></div>
      <!-- END buttons -->
</div>

      </dd>
  </dl>

  <div class="package-changes">
    <ul class="package-changes__version">
      {% include "allmychanges/blocks/package-changes.html" %}
    </ul>
  </div>
  <script>
    $(document).ready(function(){
      // делаем табло со списком версий прилипающим кверху при прокрутке
      $(".version-links-container").sticky({
        topSpacing:0,
        className: "version-links-container__sticky",
        wrapperClassName: "version-links-container__wrapper"
      });

      // обрабатываем клик, чтобы при прокрутке не загораживать
      // кусок changelog с выбранной версией
      var version_links_height = $('.version-links').height();

      $('.version-links__item a').click(function (ev) {
        ev.preventDefault();
        var version = $(this).text();
        var section_top = $('[name="' + version + '"]').position().top;

        var top = section_top - (version_links_height + 20);
        if ($('.version-links__sticky').length == 0) {
          // это нужно потому, что когда заголовок становится липким, то его содержимое
          // вычитается из высоты страницы, сдвигая все заголовки вверх
          top -= version_links_height + 20;
        }
        window.scroll(0, top);
      });
    
      // используем плагин, чтобы помечать ссылку с текущей версией
      $(".package-version__number a").waypoint({
        handler: function (direction) {
          $(".version-links__item").removeClass("version-links__selected-item");
          $(".version-links__item-" + this.element.text.replace(/\./g, "-")).addClass("version-links__selected-item");
        },
        offset: "30%"
      });

      intro.push({'element': $(".page-header__buttons")[0],
                  'intro': 'Use these buttons to follow new packages or report about issues.'
                 }, 1000);
    });
  </script>
{% endblock content %}
